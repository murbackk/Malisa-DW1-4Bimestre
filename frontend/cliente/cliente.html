<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD Cliente - Zênite</title>

    <link rel="stylesheet" href="/frontend/global.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
</head>
<body>

<header>
    <div>
        <h1>CRUD Cliente</h1>
    </div>
    <a href="#" onclick="voltarDashboard()">← Voltar ao Dashboard</a>
</header>

<main>
    <section>
        <h2>Cadastro de Cliente</h2>

        <form id="clienteForm">
            <div>
                <label for="searchId">Buscar por ID:</label>
                <div>
                    <input type="number" id="searchId" placeholder="Digite o ID para buscar">
                    <button type="button" id="btnBuscar">Buscar</button>

                    <button type="button" id="btnIncluir">Incluir</button>
                    <button type="button" id="btnAlterar" style="display: none;">Alterar</button>
                    <button type="button" id="btnExcluir" style="display: none;">Excluir</button>
                    <button type="button" id="btnSalvar" style="display: none;">Salvar</button>
                    <button type="button" id="btnCancelar">Cancelar</button>
                </div>
            </div>

            <fieldset id="formFields">
                <legend>Dados do Cliente</legend>

                <div>
                    <label for="idCliente">ID Cliente:</label>
                    <input type="number" id="idCliente" required disabled>
                </div>

                <div>
                    <label for="idUsuario">ID Usuário:</label>
                    <input type="number" id="idUsuario" required disabled>
                </div>

                <div>
                    <label for="dataCadastro">Data de Cadastro:</label>
                    <input type="datetime-local" id="dataCadastro" required disabled>
                </div>
            </fieldset>
        </form>
    </section>

    <section>
        <h3>Lista de Clientes</h3>
        <div>
            <table id="clienteTable">
                <thead>
                    <tr>
                        <th>ID Cliente</th>
                        <th>ID Usuário</th>
                        <th>Data Cadastro</th>
                    </tr>
                </thead>
                <tbody id="clienteTableBody">
                </tbody>
            </table>
        </div>
    </section>
</main>

<div id="messageContainer"></div>

<script>
    const API_URL = 'http://localhost:3001/cliente';

    let modoEdicao = false;
    let clienteAtual = null;

    // DOM Elements
    const searchId = document.getElementById('searchId');
    const idCliente = document.getElementById('idCliente');
    const idUsuario = document.getElementById('idUsuario');
    const dataCadastro = document.getElementById('dataCadastro');

    const btnBuscar = document.getElementById('btnBuscar');
    const btnIncluir = document.getElementById('btnIncluir');
    const btnAlterar = document.getElementById('btnAlterar');
    const btnExcluir = document.getElementById('btnExcluir');
    const btnSalvar = document.getElementById('btnSalvar');
    const btnCancelar = document.getElementById('btnCancelar');

    const clienteTableBody = document.getElementById('clienteTableBody');
    const messageContainer = document.getElementById('messageContainer');

    document.addEventListener('DOMContentLoaded', () => {
        carregarTabela();
        configurarEventos();
    });

    function configurarEventos() {
        btnBuscar.addEventListener('click', buscarCliente);
        btnIncluir.addEventListener('click', incluirCliente);
        btnAlterar.addEventListener('click', alterarCliente);
        btnExcluir.addEventListener('click', excluirCliente);
        btnSalvar.addEventListener('click', salvarCliente);
        btnCancelar.addEventListener('click', cancelarOperacao);
    }

    async function buscarCliente() {
        const id = parseInt(searchId.value);
        if (!id) return mostrarMensagem('Digite um ID válido.', 'error');

        try {
            const response = await fetch(`${API_URL}/${id}`);

            if (response.ok) {
                const cliente = await response.json();
                preencherFormulario(cliente);
                mostrarMensagem('Cliente encontrado!', 'success');
                mostrarBotoesEdicao();
            } else {
                mostrarMensagem('Cliente não encontrado.', 'error');
                limparFormulario();
            }
        } catch (e) {
            mostrarMensagem('Erro de conexão.', 'error');
        }
    }

    function incluirCliente() {
        limparFormulario();
        habilitarFormulario();
        modoEdicao = false;
        clienteAtual = null;
        mostrarBotaoSalvar();
        mostrarMensagem('Preencha os dados do novo cliente.', 'info');
    }

    function alterarCliente() {
        if (!clienteAtual) return mostrarMensagem('Nenhum cliente selecionado.', 'error');
        habilitarFormulario();
        idCliente.disabled = true;
        modoEdicao = true;
        mostrarBotaoSalvar();
        mostrarMensagem('Edite os dados.', 'info');
    }

    async function excluirCliente() {
        if (!clienteAtual) return mostrarMensagem('Nenhum cliente selecionado.', 'error');

        if (!confirm('Tem certeza que deseja excluir?')) return;

        const response = await fetch(`${API_URL}/${clienteAtual.idcliente}`, { method: 'DELETE' });

        if (response.ok || response.status === 204) {
            mostrarMensagem('Excluído com sucesso!', 'success');
            carregarTabela();
            limparFormulario();
        } else {
            const data = await response.json();
            mostrarMensagem(data.error, 'error');
        }
    }

    async function salvarCliente() {
        const idusuario = parseInt(idUsuario.value);
        const datacadastrocliente = dataCadastro.value;

        if (!idusuario || !datacadastrocliente) {
            return mostrarMensagem('Preencha todos os campos.', 'error');
        }

        let response;
        let dados = { idusuario, datacadastrocliente };

        if (modoEdicao && clienteAtual) {
            response = await fetch(`${API_URL}/${clienteAtual.idcliente}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });
        } else {
            dados.idcliente = parseInt(idCliente.value);
            response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });
        }

        if (response.ok || response.status === 201) {
            mostrarMensagem('Salvo com sucesso!', 'success');
            carregarTabela();
            cancelarOperacao();
        } else {
            const data = await response.json();
            mostrarMensagem(data.error, 'error');
        }
    }

    function preencherFormulario(c) {
        idCliente.value = c.idcliente;
        idUsuario.value = c.idusuario;
        dataCadastro.value = c.datacadastrocliente
            ? new Date(c.datacadastrocliente).toISOString().slice(0, 16)
            : '';
        clienteAtual = c;
    }

    function limparFormulario() {
        idCliente.value = '';
        idUsuario.value = '';
        dataCadastro.value = '';
        clienteAtual = null;
    }

    function habilitarFormulario() {
        idCliente.disabled = false;
        idUsuario.disabled = false;
        dataCadastro.disabled = false;
    }

    function desabilitarFormulario() {
        idCliente.disabled = true;
        idUsuario.disabled = true;
        dataCadastro.disabled = true;
    }

    function mostrarBotoesEdicao() {
        btnAlterar.style.display = 'inline-block';
        btnExcluir.style.display = 'inline-block';
        btnSalvar.style.display = 'none';
    }

    function mostrarBotaoSalvar() {
        btnAlterar.style.display = 'none';
        btnExcluir.style.display = 'none';
        btnSalvar.style.display = 'inline-block';
    }

    function cancelarOperacao() {
        limparFormulario();
        desabilitarFormulario();
        esconderBotoesEdicao();
        modoEdicao = false;
    }

    function esconderBotoesEdicao() {
        btnAlterar.style.display = 'none';
        btnExcluir.style.display = 'none';
        btnSalvar.style.display = 'none';
    }

    async function carregarTabela() {
        try {
            const response = await fetch(API_URL);
            const lista = await response.json();

            clienteTableBody.innerHTML = '';

            lista.forEach(c => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${c.idcliente}</td>
                    <td>${c.idusuario}</td>
                    <td>${new Date(c.datacadastrocliente).toLocaleString()}</td>
                `;

                row.addEventListener('click', () => {
                    preencherFormulario(c);
                    searchId.value = c.idcliente;
                    mostrarBotoesEdicao();
                    mostrarMensagem('Cliente selecionado.', 'info');
                });

                clienteTableBody.appendChild(row);
            });
        } catch (e) {
            mostrarMensagem('Erro ao carregar tabela.', 'error');
        }
    }

    function mostrarMensagem(texto, tipo) {
        const msg = document.createElement('div');
        msg.textContent = texto;
        msg.className = 'msg-' + tipo;
        msg.style.padding = '10px';
        msg.style.position = 'fixed';
        msg.style.top = '20px';
        msg.style.right = '20px';
        msg.style.background = tipo === 'success'
            ? '#059669'
            : tipo === 'error'
            ? '#dc2626'
            : '#3b82f6';
        msg.style.color = 'white';
        msg.style.borderRadius = '5px';
        msg.style.zIndex = '9999';

        messageContainer.appendChild(msg);
        setTimeout(() => msg.remove(), 3500);
    }

    function voltarDashboard() {
        if (confirm('Tem certeza que deseja voltar ao dashboard?')) {
            window.history.back();
        }
    }
</script>

</body>
</html>
